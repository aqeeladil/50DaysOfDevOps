## Iptables Guide

### 1. Basic Concepts
Iptables is a user-space utility for configuring the Linux kernel firewall. It works by manipulating packet filtering rules within the kernel's Netfilter framework. Iptables evaluates network packets against a set of rules to determine whether they should be allowed, dropped, or modified.

There are several tables in iptables, each serving different purposes:
- **Filter Table**: The default table used for packet filtering.
- **NAT Table**: Handles Network Address Translation (NAT) for modifying packet source/destination addresses.
- **Mangle Table**: Alters packet headers for advanced routing and traffic shaping.
- **Raw Table**: Used for configuring packets before connection tracking.
- **Security Table**: Applies security-related policies via SELinux.

### 2. Chain Management
Iptables organizes rules into chains, which define the path packets take through the firewall:
- **INPUT**: Handles packets destined for the local system.
- **OUTPUT**: Manages packets generated by the local system.
- **FORWARD**: Governs packets being routed through the system.

Each chain follows a default policy (ACCEPT, DROP, or REJECT) when no explicit rule matches a packet.

### 3. Rule Creation
To allow incoming SSH traffic on port 22:
```bash
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
```
**Explanation:**
- `-A INPUT`: Append the rule to the INPUT chain.
- `-p tcp`: Specify the protocol (TCP).
- `--dport 22`: Match packets destined for port 22.
- `-j ACCEPT`: Allow the matched packets.

### 4. Rule Deletion
To delete a rule blocking HTTP traffic (port 80):
```bash
iptables -D INPUT -p tcp --dport 80 -j DROP
```
Alternatively, list rules with:
```bash
iptables -L --line-numbers
```
and delete by number:
```bash
iptables -D INPUT <rule-number>
```

### 5. Logging
Logging helps monitor and debug firewall activity. To log all dropped packets:
```bash
iptables -A INPUT -m limit --limit 5/min -j LOG --log-prefix "Dropped: " --log-level 4
```

### 6. Persistent Rules
To ensure iptables rules persist across reboots:
- **Ubuntu/Debian**: Save rules using:
  ```bash
  sudo iptables-save > /etc/iptables/rules.v4
  ```
  Restore rules at boot using:
  ```bash
  sudo iptables-restore < /etc/iptables/rules.v4
  ```
- **CentOS/RHEL**:
  ```bash
  sudo service iptables save
  ```
  and enable on boot:
  ```bash
  sudo systemctl enable iptables
  ```

### 7. Advanced Filtering
To block traffic from a specific IP (e.g., `192.168.1.100`):
```bash
iptables -A INPUT -s 192.168.1.100 -j DROP
```

### 8. Connection Tracking
Connection tracking (stateful firewall) allows iptables to recognize ongoing connections. Example rule to allow only established and related connections:
```bash
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
```

### 9. Custom Chains
Custom chains allow better rule organization. Example:
```bash
iptables -N MYCHAIN
iptables -A INPUT -p tcp --dport 8080 -j MYCHAIN
iptables -A MYCHAIN -s 10.0.0.1 -j ACCEPT
iptables -A MYCHAIN -j DROP
```

### 10. Testing and Debugging
To troubleshoot issues:
1. **List rules:**
   ```bash
   iptables -L -v -n
   ```
2. **Check logs:**
   ```bash
   dmesg | grep "Dropped:"
   ```
3. **Flush rules (for testing only):**
   ```bash
   iptables -F
   ```
4. **Use tcpdump:**
   ```bash
   tcpdump -i eth0 port 22
   ```

